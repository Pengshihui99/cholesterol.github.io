---
title: "Project Report"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(haven)
library(sf)
knitr::opts_chunk$set(
  warning = FALSE, 
  message = FALSE,
  fig.align = 'center')


theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

## **Motivation**
Our project aims to explore the intricate relationship between health affecting behaviors and the health outcome of High cholesterol levels. With the growing concern about cardiovascular diseases and their association with lifestyle choices, understanding these relationships is crucial. We intend to use comprehensive datasets to analyze and model these associations, providing insights that could lead to better health outcomes.

## **Related Work**
Our inspiration stems from an introductory article by the American Heart Association (2020) titled "What is Cholesterol?" This article shed light on the profound impact of cholesterol on the human body. Recognizing that daily eating habits and behaviors can contribute to elevated cholesterol levels and pose a risk to cardiovascular health, we aim to develop a website. This platform aims to empower individuals by providing insights into their cholesterol levels, educating them about the associated risks, and encouraging proactive steps to maintain or enhance their overall health.

## **Initial Questions**
The purposes of this project is to answer the following questions:

- What kind and extent of the correlations between our targeted health outcome - high cholesterol and health related behaviors at national level?
- What patterns do their correlation exhibit in the graphs?
- By using the individual dataset, which models are effective in capturing the association between high cholesterol and a set of health-related behaviors identified in national dataset that exhibit a strong correlation?
- How can we create a user-friendly tool enabling individuals to evaluate their personal risk of high cholesterol using demographic features and lifestyle choices?

## **Data Sources and Cleaning**
### *Part 1: [PLACES: Local Data for Better Health](https://data.cdc.gov/500-Cities-Places/PLACES-Local-Data-for-Better-Health-County-Data-20/swc5-untb/about_data)*

We acquire county level health prevalence data of the entire United States during the time period from 2020 to 2021. The data were provided by the CDC, Division of Population Health, Epidemiology and Surveillance Branch.It has 229K rows and 21 columns initially. The estimates encompass 36 measures, spanning health outcomes, preventive services use, chronic disease-related health risk behaviors, disabilities, and health status. We are using several health-affecting behavior variables and the prevalence of High Cholesterol to evaluate and sorting out the most correlated risk factors to the outcome at the national level.

```{r, message=FALSE, warning=FALSE}


library(tidyverse)
library(purrr)
library(dplyr)
library(plotly)
library(tools)

prevalence_df = read_csv("data/PLACES__Local_Data_for_Better_Health__County_Data_2023_release.csv") |>
  janitor::clean_names() |>
  select(year, state_abbr, category, measure, data_value, total_population, category_id, measure_id, short_question_text) |>
  filter(year == 2021)

prevalence_outcome = prevalence_df |>
  filter(category == "Health Outcomes")
  
prevalence_chol = prevalence_outcome |>
  filter(measure_id == "HIGHCHOL") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(chol_pre_2021 = disease_popu / total_popu) |>
  select(-disease_popu)
  
  
prevalence_risk = prevalence_df |>
  filter(category == "Health Risk Behaviors")
  

risk_lpa = prevalence_risk |>
  filter(measure_id == "LPA") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(lpa_pre = disease_popu / total_popu) |>
  select(-disease_popu)


risk_binge = prevalence_risk |>
  filter(measure_id == "BINGE") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(binge_pre = disease_popu / total_popu) |>
  select(-disease_popu)


risk_smoking = prevalence_risk |>
  filter(measure_id == "CSMOKING") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(smoking_pre = disease_popu / total_popu) |>
  select(-disease_popu)


prevalence_prevention = prevalence_df |>
  filter(category == "Prevention")

prevention_insurance = prevalence_prevention |>
  filter(measure_id == "ACCESS2") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(insurance_pre = disease_popu / total_popu) |>
  select(-disease_popu)

prevention_cholscreen = prevalence_prevention |>
  filter(measure_id == "CHOLSCREEN") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(cholscreen_pre = disease_popu / total_popu) |>
  select(-disease_popu)


prevalence_df_2020 = read_csv("data/PLACES__Local_Data_for_Better_Health__County_Data_2023_release.csv") |>
  janitor::clean_names() |>
  select(year, state_abbr, category, measure, data_value, total_population, category_id, measure_id, short_question_text) |>
  filter(year == 2020)

risk_sleep_2020 = prevalence_df_2020 |>
  filter(category == "Health Risk Behaviors") |>
  filter(measure_id == "SLEEP") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(sleep_pre = disease_popu / total_popu) |>
  select(-disease_popu)


prevalence_chol_2020 = prevalence_df |>
  filter(category == "Health Outcomes") |>
  filter(measure_id == "HIGHCHOL") |>
  select(state_abbr, data_value, total_population) |>
  mutate(dis_popu = as.integer(total_population * data_value * 0.01)) |>
  group_by(state_abbr) |>
  summarise(state_abbr, total_popu = sum(total_population), disease_popu = sum(dis_popu)) |>
  distinct() |>
  mutate(chol_pre_2020 = disease_popu / total_popu) |>
  select(-disease_popu)

merged_2021 = Reduce(function(df1, df2) left_join(df1, df2, by = c("state_abbr", "total_popu")), list(prevalence_chol, risk_binge, risk_lpa, risk_smoking, prevention_insurance, prevention_cholscreen))

merged_2020 = left_join(prevalence_chol_2020, risk_sleep_2020)
merged_total = left_join(merged_2021, merged_2020)
```


### *Part 2: [NHANCES](https://wwwn.cdc.gov/nchs/nhanes/continuousnhanes/default.aspx?Cycle=2017-2020)*
In order to get individual data measurements to analyze the association of risk factors and `high Cholesterol`, we use the several sub-datasets from `NHANCES` to gather all the variables we are interested from the result of part 1. This resource conducted by the CDC for the time period of 2017 to March 2020 Pre-pandemic. It combines interviews and physical examinations to collect a wide range of health-related information. Initially, all the variables were non-descriptive, we assigned descriptive names for them. While importing the data measurements, the types of all the variables were numberical. Except continuous variables, we categorizd variables `gender`, `race`, `marital_status`, `education_level`, `poverty_level`, and `alcohol_use_cat`. The numbers from drinking habit dataset are not order in a logic way, therefore we reordered variables as `alcohol_use_order`. The dataset with information of physical activity used the skip methods 
The comprehensive dataset employed for our analysis includes detail information for each participant, including key variables such as:

  - `id`: Participants' unique identification numbers
  - `total_cholesterol`: Serum total cholesterol level, in mg/dL
  - `age`: participants' Age at screening , in year
  - `gender`: 2 types: Male or Female
  - `race`: 5 types: Hispanic, Non-Hispanic White, Non-Hispanic Black, Non-Hispanic Asian, Other Race
  - `marital_status`: For the adults 20+ years old, 3 typess: Married/Living with Partner, Widowed/Divorced/Separated, Never married
  - `education_level`: For the adults 20+ years old, 4 levels: Less than 9th grade, 9-11th grade, High school graduate/GED or equivalent, Some college or AA degree, College graduate or above
  - `bmi`: Body Mass Index, in kg/m**2
  - `poverty_level`: Family monthly poverty level category, 3 levels: Below 130% of Poverty Guidelines, Between 130% and 185% of Poverty Guidelines, Above 185% of Poverty Guidelines
  - `physical_activity`: Types of weekly physical activity, 3 levels: Vigorous activity, Moderate activity, Light/Unknown activity
  - `sleep_hour`: The sleeping habits in Weekdays or workdays, in hour
  - `alcohol_use_order`: Ordinal variables, scale from 1 - 11 meaning from never to everyday consuming the alcohol in the past twelve months
  - `alcohol_use_cat`: Category of drinking patterns, 3 levels: Light Drinker, Moderate Drinker, Heavy Drinker
  - `cotinine`: Serum Cotinine concentration, in ng/mL

```{r}
tchol_df = 
  data <- read_xpt("data/xpt/P_TCHOL.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, total_cholesterol = lbxtc) |> 
  drop_na()

demo1_df = 
  data <- read_xpt("data/xpt/P_DEMO.XPT") |> 
  janitor::clean_names() |> 
  select(id = seqn, age = ridageyr, gender = riagendr, race = ridreth3, 
         marital_status = dmdmartz, education_level_20 = dmdeduc2) |> #only include the variables of id, age, gender, race, marital status, and education level.
  filter(age >= 18) |> # Only include the participants with age equal and greater than 18.
  mutate(
    gender = case_when(
      gender == 1 ~ "Male",
      gender == 2 ~ "Female",
      TRUE ~ as.character(gender)), #categorize variable gender.
    race = case_when(
      race %in% c(1, 2) ~ "Hispanic",
      race == 3 ~ "Non-Hispanic White",
      race == 4 ~ "Non-Hispanic Black",
      race == 6 ~ "Non-Hispanic Asian",
      race == 7 ~ "Other Race",
      TRUE ~ as.character(race)), #categorize variable race.
    marital_status = case_when(
      marital_status %in% c(77, 99, ".") ~ NA_character_,
      marital_status == 1 ~ "Married/Living with Partner",
      marital_status == 2 ~ "Widowed/Divorced/Separated",
      marital_status == 3 ~ "Never married",
      TRUE ~ as.character(marital_status)), #categorize variable marital status.
    education_level_20 = case_when(
      education_level_20 %in% c(7, 9, ".") ~ NA_character_,
      education_level_20 == 1 ~ "Less than 9th grade",
      education_level_20 == 2 ~ "9-11th grade",
      education_level_20 == 3 ~ "High school graduate/GED or equivalent",
      education_level_20 == 4 ~ "Some college or AA degree",
      education_level_20 == 5 ~ "College graduate or above",
      TRUE ~ as.character(education_level_20)) #categorize education level status.
   )

bmi_df = 
  data <- read_xpt("data/xpt/P_BMX.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, bmi = bmxbmi) |> 
  drop_na()

income_df = 
  read_xpt("data/xpt/P_INQ.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, poverty_level = indfmmpi) |> 
  drop_na() |> 
  mutate(
    poverty_level = case_when(
      poverty_level < 1.3 ~ "Below 130% of Poverty Guidelines",
      between(poverty_level, 1.3, 1.85) ~ "Between 130% and 185% of Poverty Guidelines",
      poverty_level > 1.85 ~ "Above 185% of Poverty Guidelines",
      TRUE ~ as.character(poverty_level))
        )

demo_df <- demo1_df |> 
  left_join(income_df, by = "id") |> 
  left_join(bmi_df, by = "id") |> 
  drop_na(age, gender, race, bmi) 

activity_df = 
  data <- read_xpt("data/xpt/P_PAQ.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, paq605, paq650, paq620, paq635, paq665) |> 
  drop_na() |> 
  mutate(
    physical_activity = case_when(
      paq605 == 1 | paq650 == 1 ~ "Vigorous activity",
      paq620 == 1 | paq635 == 1 | paq665 == 1 ~ "Moderate activity",
      paq665 == 2 ~ "Light/Unknown activity",
      TRUE ~ NA_character_ )
        ) |> 
  select(id, physical_activity)

sleep_df = 
  data <- read_xpt("data/xpt/P_SLQ.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, sleep_hour = sld012) |> 
  drop_na()

alcohol_df = 
  data <- read_xpt("data/xpt/P_ALQ.XPT") |> 
  janitor::clean_names() |>
  mutate(
    alcohol_use_cat = case_when(
      alq121 %in% c(0, 10, 9, 8) ~ "Light Drinker",
      alq121 %in% c(7, 6, 5, 4) ~ "Moderate Drinker",
      alq121 %in% c(3, 2, 1) ~ "Heavy Drinker",
      alq121 %in% c(77, 99, ".") ~ NA_character_),
     alcohol_use_order = case_when(
      alq121 == 0 ~ 1,
      alq121 == 10 ~ 2,
      alq121 == 9 ~ 3,
      alq121 == 8 ~ 4,
      alq121 == 7 ~ 5,
      alq121 == 6 ~ 6,
      alq121 == 5 ~ 7,
      alq121 == 4 ~ 8,
      alq121 == 3 ~ 9,
      alq121 == 2 ~ 10,
      alq121 == 1 ~ 11)
        ) |> 
   select(id = seqn, alcohol_use_cat, alcohol_use_order) |> 
   drop_na()

smoking_df = 
  data <- read_xpt("data/xpt/P_COT.XPT") |> 
  janitor::clean_names() |>
  select(id = seqn, cotinine = lbxcot) |> 
  drop_na()

combine_df = 
  tchol_df |> 
  left_join(demo_df, by = "id") |>
  left_join(activity_df, by = "id") |>
  left_join(sleep_df, by = "id") |>
  left_join(alcohol_df, by = "id") |>
  left_join(smoking_df, by = "id") |> 
  drop_na(age, gender, race)

write.csv(combine_df, file = "data/combine.csv")

combine_df %>% 
  knitr::kable(digits = 3) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12) %>% 
  kableExtra::scroll_box(width = "100%", height = "300px")
```

Above is the final dataset `combine_df`, with 8161 observations and 14 variables will be used in following steps of exploratory and statistical analysis. 


## **Exploratory Analysis** 

## Prevalence Analysis 

### Visulization

#### The U.S. High Cholesterol Map 
This is to have an overview of the prevalence of high cholesterol among the nation.
```{r, message=FALSE, warning=FALSE}

library(scales)

library(sf)

states = read_sf("data/cb_2022_us_state_500k/") |>
  rename("state_abbr" = "STUSPS")

chol_small_df = merged_total |>
  select(state_abbr, chol_pre_2021)

state_to_remove = c("GU", "MP", "VI", "PR", "AS", "AK", "HI")

geo_df = left_join(states, chol_small_df) |>
  rename("STUSPS" = "state_abbr") |>
  filter(! STUSPS %in% state_to_remove) 

map_plot = ggplot(geo_df) +
  geom_sf(aes(fill = chol_pre_2021, text = paste("State: ", NAME, "<br>Prevalence: ", percent(round(chol_pre_2021, digits = 3))))) +
  scale_fill_distiller("Prevalence", palette="YlOrRd") +
  theme_minimal() +
  theme(axis.ticks = element_blank(), axis.text = element_blank()) +
  labs(title = "Prevalence of High Cholesterol by State")

state_map = ggplotly(map_plot, tooltip = "text") 

 
state_map


```

* Based on the map, we can find that the prevalences of high cholesterol varied among the nation, but were generally higher in the south than in the north of the USA.

#### Health Behaviors Prevalence Boxplot
Draw a boxplot to visualize the prevalence of each health behavior that is related to and has potential association with high cholesterol.
```{r, message=FALSE, warning=FALSE}
chol_pivot = merged_total |>
  select(state_abbr, chol_pre_2020, chol_pre_2021) |>
  pivot_longer(chol_pre_2020 : chol_pre_2021,
               names_to = "chol_year",
               values_to = "prevalence") |>
  mutate(chol_year = case_match(chol_year,
                                "chol_pre_2020" ~ "High Cholesterol 2020",
                                "chol_pre_2021" ~ "High Cholesterol 2021"
                                  ))


behavior_pivot  = merged_total |>
  select(-total_popu, -chol_pre_2021, -chol_pre_2020) |>
  pivot_longer(binge_pre : sleep_pre,
               names_to = "behavior",
               values_to = "prevalence") |>
  mutate(behavior = case_match(behavior,
                               "lpa_pre" ~ "No Leisure-time Physical Activity",
                               "sleep_pre" ~ "Sleep Less Than 7 Hours",
                               "smoking_pre" ~ "Smoking Currently",
                               "insurance_pre" ~ "Lack of Health Insurance",
                               "cholscreen_pre" ~ "Cholesterol Screening",
                               "binge_pre" ~ "Binge Drinking"
                               ),
         behavior = factor(behavior, levels = behavior))
  

y_range_box = range(pull(chol_pivot, prevalence), pull(behavior_pivot, prevalence))

plot1 = chol_pivot |>
  plot_ly(y = ~prevalence, color = ~chol_year, type = "box", colors = c("#F5761A", "#b73779")) |>
  layout(
         xaxis = list(title = 'Year', tickangle=-45),
         yaxis = list(range = y_range_box + c(-0.01, 0.01))
         )
#legend = list(title = list(text = "Chol Year"
plot2 = behavior_pivot |>
  plot_ly(y = ~prevalence, color = ~behavior, type = "box", colors = "viridis") |>
  layout(title = 'High Cholesterol & Behaviors Prevalence',
         xaxis = list(tickangle=-45),
         yaxis = list(range = y_range_box + c(-0.01, 0.01)))


box_plot = subplot(plot1, plot2)

box_plot
```

* Based on the boxplot, we can find that prevalence of high cholesterol was similar between 2020 and 2021. Lacking sleep was the most appreciable health-adverse behavior, followed by lacking physical activities. Binge drinking and smoking problem also existed, while they were not significant compared to other health-adverse behavior. The prevalence of cholesterol screening is high, while the prevalence of lacking health insurance is low. These indicate health-promote behavior.

### Find Top Behaviors
* We try to find the top factors that affect high cholesterol most in terms of correlation

#### Association Trend Plot 
This is to observe trendings of associations between prevalence of high cholesterol and prevalence of related health-affecting behaviors.
```{r warning=FALSE, warning=FALSE}

x_range = range(c(pull(merged_total, chol_pre_2021), pull(merged_total, chol_pre_2020)))

y_range = range(c(pull(merged_total, binge_pre), pull(merged_total, lpa_pre), pull(merged_total, smoking_pre), pull(merged_total, insurance_pre), pull(merged_total, cholscreen_pre), pull(merged_total, sleep_pre)))

prevalence_plot = 
merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~binge_pre, type = 'scatter', size = ~total_popu, sizes = c(50, 250), mode = 'markers', opacity = 0.75, name = 'Binge Drinking', showlegend = TRUE, visible = TRUE) |>
  add_trace(x = ~chol_pre_2021, y = ~lpa_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(50, 250), name = 'No Leisure-time Physical Activity', showlegend = TRUE, visible = TRUE) |>
  add_trace(x = ~chol_pre_2021, y = ~smoking_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(50, 250), name = 'Smoking Currently', showlegend = TRUE, visible = TRUE) |>
  add_trace(x = ~chol_pre_2021, y = ~insurance_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(50, 250), name = 'Lack of Health Insurance Currently', showlegend = TRUE, visible = TRUE) |>
  add_trace(x = ~chol_pre_2021, y = ~cholscreen_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(50, 250), name = 'Cholesterol Screening', showlegend = TRUE, visible = TRUE) |>
  add_trace(x = ~chol_pre_2021, y = ~sleep_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(50, 250), name = 'Sleep Less Than 7 Hours', showlegend = TRUE, visible = TRUE) |>
  
  layout(title = list(text = 'Prevalence of High Cholesterol v.s. Health-Affecting Behaviors', x = 0.08),
         titlefont = list(size = 15),
         xaxis = list(title = 'Prevalence of High Cholesterol',  tickformat = '.0%', showline = TRUE, range = x_range + c(-0.01, 0.01)),
         yaxis = list(title = 'Prevalence of Health-Affecting Behavior', range = y_range + c(-0.05, 0.05), tickformat = '.0%', showline = TRUE))
         

prevalence_plot

```

* Based on the trend, when the prevalence of high cholesterol increased, we can find the prevalence of smoking, lacking physical activity, lacking sleep, lacking health insurance, and cholesterol screening also increased. The trend of the prevalence of binge drinking is not obvious. Therefore, we move to check sub-association trending plot.

#### Sub-Association Trending Plot
To have a clearer view of each behavior, let's "zoom in" and observe the trending in more detail.
```{r, message=FALSE, warning=FALSE}
fig1 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~binge_pre, type = 'scatter', size = ~total_popu, sizes = c(25, 125), mode = 'markers', opacity = 0.75, name = 'Binge Drinking', showlegend = TRUE, visible = TRUE) |> layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%'))

fig2 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~lpa_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(25, 125), name = 'No Leisure-time Physical Activity', showlegend = TRUE, visible = TRUE) |> layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%')) 


fig3 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~smoking_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(25, 125), name = 'Smoking Currently', showlegend = TRUE, visible = TRUE) |>
layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%')) 

fig4 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~insurance_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(25, 125), name = 'Lack of Health Insurance Currently', showlegend = TRUE, visible = TRUE) |> layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%'))

fig5 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~cholscreen_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(25, 125), name = 'Cholesterol Screening', showlegend = TRUE, visible = TRUE) |> layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%'))

fig6 = merged_total |>
  plot_ly() |>
  add_trace(x = ~chol_pre_2021, y = ~sleep_pre, type = 'scatter', mode = 'markers', size = ~total_popu, sizes = c(25, 125), name = 'Sleep Less Than 7 Hours', showlegend = TRUE, visible = TRUE) |>
  layout(xaxis = list(tickformat = '.0%'), yaxis = list(tickformat = '.0%'))

pre_sub_figs = subplot(fig1, fig2, fig3, fig4, fig5, fig6, nrows = 2) |>
  layout(title = list(text = 'Prevalence of High Cholesterol v.s. Health-Affecting Behaviors', x = 0.08), titlefont = list(size = 15))

pre_sub_figs
  
```

* Based on these trending plots, we can find the prevalence of high cholesterol was (1) positively associated with the prevalence of smoking, lacking physical activity, lacking sleep, lacking health insurance, and cholesterol screening; and (2) negatively associated with the prevalence of binge drinking.



#### Calculate the correlation between each behavior and high cholesterol
```{r, message=FALSE, warning=FALSE}

cor_table = data.frame(behavior = character(), correlation = numeric(), stringsAsFactors = FALSE)

behavs = colnames(merged_2021[4:8])

for (each in behavs) {
  new_row = data.frame(behavior = substr(each, 1, nchar(each) - 4), correlation = round(cor(pull(merged_2021, chol_pre_2021), pull(merged_2021, each)), digits = 4))
  
  cor_table = rbind(cor_table, new_row)
}

sleep_row = data.frame(behavior = 'sleep', correlation = round(cor(pull(merged_2020, chol_pre_2020), pull(merged_2020, sleep_pre)), digits = 4))

cor_table = rbind(cor_table, sleep_row)
cor_table = arrange(cor_table, desc(abs(correlation)))

cor_table = cor_table |>
  mutate(behavior = case_match(behavior,
                               "lpa" ~ "No Leisure-time Physical Activity",
                               "sleep" ~ "Sleep Less Than 7 Hours",
                               "smoking" ~ "Smoking Currently",
                               "insurance" ~ "Lack of Health Insurance Currently",
                               "cholscreen" ~ "Cholesterol Screening",
                               "binge" ~ "Binge Drinking"
                               ),
         behavior = factor(behavior, levels = behavior)) |>
  rename("Behavior" = behavior,
         "Correlation" = correlation) 


knitr::kable(cor_table)

```

#### Correlation Bar Chart
Use a bar chart to visualize it.
```{r, message=FALSE, warning=FALSE}

cor_bar = plot_ly(cor_table, x = ~Behavior, y = ~Correlation, type = 'bar', text = ~Correlation, texttemplate = '%{y:.2f}', textposition = 'outside', opacity = 0.8, marker = list(color = "MidnightBlue")) |>
  layout(title = 'Correlation Between High Cholesterol and Health Behaviors',
         xaxis = list(title = 'Behavior', tickangle=-30),
         yaxis = list(title = 'Correlation')) 
 
  

cor_bar
```

* Based on the table results and bar chart, we can find that the health-adverse behavior lacking physical activities, lacking sleep, binge drinking, and smoking had top four high correlations with high cholesterol. Binge drinking had a negative correlation with high cholesterol, which is against the common sense. 

* Therefore, we decide to examine the associations between these four health-adverse behaviors and total cholesterol, and then to provide a statistical model to predict high total cholesterol risk for users.

## Individual-level Modeling
```{r, echo=FALSE,message=FALSE, warning=FALSE}
library(ggridges)
library(tidyverse)
library(plotly)
library(gridExtra)

combine_df = read_csv("data/combine.csv") 

combine_tc_binary = read_csv("data/combine.csv") |> 
  mutate(
    total_cholesterol = case_when(
      total_cholesterol < 200 ~ "desirable",
      total_cholesterol >= 200 ~ "above desirable",
      TRUE ~ as.character(total_cholesterol)
    )
  )
```

We first explore the distribution of interested outcome variable, Total cholesterol, then explore the distributions of four exposure variables and their relationship of TC. 


The maximum of TC is `r max ( combine_df $ total_cholesterol)`, the 75% quantile is `r quantile(combine_df $ total_cholesterol,0.75)`, the median is `r median(combine_df $ total_cholesterol)` ,  the low 25% quantile is `r quantile(combine_df $ total_cholesterol,0.25)` , the minimum is `r min ( combine_df $ total_cholesterol)`. And the distribution is shown as below. 

```{r, message = FALSE, warning=FALSE}
TC_distri = ggplot(combine_df, aes(x = total_cholesterol)) +
  geom_histogram(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(
    x = "Total Cholesterol",
    y = "Frequency",
    title = "Distribution of Total Cholesterol"
  ) +
  theme_minimal()

ggplotly(TC_distri)
```


The distribution of `Total Cholesterol`is right-skewed graph, which concentrated within the range of 150 to 200 mg/dL. Given the absence of asymmetry in the distribution of total cholesterol, we will employ the logarithm transformation on the total cholesterol values for the subsequent steps of our analysis.

According to [CDC](https://www.cdc.gov/cholesterol/index.htm). High cholesterol is defined as total cholesterol level greater than 200mg/dL. We use 200 mg/dl as cutoff point in the following analysis. In the following report, total cholesterol smaller than 200 mg/dL is defined as "desirable" ,  otherwise it is defined as " above desirable".


```{r, message = FALSE, warning = FALSE}
TC_sleep = 
  plot_ly(combine_tc_binary, x = ~total_cholesterol, y = ~sleep_hour, color = ~total_cholesterol, type = "box", colors = "viridis") |> 
  layout(title = "Total Cholesterol & Sleep Hours",
         xaxis = list(title = "Total Cholesterol"),
         yaxis = list(title = "Sleep Hours"))

TC_sleep
```

The first variable we include is sleep hour. Our analysis of sleep hour distribution in the sample population reveals a normal distribution, with a prevailing trend of individuals obtaining approximately 7 to 8 hours of sleep per night. The accompanying boxplot, which compares sleep hours with total cholesterol levels, underscores a remarkable similarity in distribution patterns between individuals categorized as "desirable" and those classified as "above desirable." This observation suggests comparable sleep duration trends in both groups, prompting further investigation into whether sleep hours might serve as a risk factor for cholesterol levels.

```{r, message = FALSE, warning = FALSE}
combine_tc_binary = 
  combine_tc_binary |> 
  drop_na(physical_activity)

TC_activity = ggplot(combine_tc_binary, aes(x = physical_activity, fill = total_cholesterol)) +
  geom_bar(position = "stack") +
  scale_fill_brewer(palette = "lightgray") +
  labs(
    x = "Physical Activity",
    y = "Frequency",
    fill = "Total Cholesterol",
    title = "Relationship between Physical Activity and Total Cholesterol"
  ) +
  theme_minimal()

ggplotly(TC_activity)
```

The second variable we include is physical activity. The bar chart illustrating the relationship between physical activity and total cholesterol levels indicates a significant prevalence of vigorous physical activity among the majority of individuals. Surprisingly, our analysis reveals that individuals with total cholesterol levels above the desirable range persist across three distinct levels of physical activity. This intriguing finding prompts questions about the intricate interplay between physical activity and cholesterol levels, hinting at the involvement of additional factors in shaping the observed patterns.


The third variable we include is alcohol use. The people who drink less than 11 times last year are defined as " light drinker", the people who drink once a month to twice a week are defined as " moderate drinkers", the people who drink more than twice a week are defined as " heavy drinkers". The distribution of alcohol use is as shown as below :
```{r message = FALSE, warning = FALSE }
combine_tc_binary = 
  combine_tc_binary %>% 
  drop_na(alcohol_use_cat) %>% 
  mutate(alcohol_use_cat = factor(alcohol_use_cat, levels=c("Light Drinker", "Moderate Drinker", "Heavy Drinker")))


Al_distri = ggplot(combine_tc_binary, aes(x =  alcohol_use_cat)) +
  geom_bar(fill = "skyblue", color = "black", alpha = 0.7) +
  labs(
    x = "Drinking Habits",
    y = "Frequency",
    title = "Distribution of Drinking Habits"
  ) +
  theme_minimal()

ggplotly(Al_distri)
```

The distribution of drinking habits is a right skewed one, with more than 3000 people are  "light drinker", around 2500 people are "moderate drinker", and around 1000 people are heavy drinker. 


The relationship between drinking habits and total cholesteral is shown as below: 

```{r message = FALSE, warning = FALSE}
combine_tc_binary %>% 
  group_by(alcohol_use_cat,total_cholesterol) %>% 
  summarise(N = n()) %>% 
  mutate (Proportion = N/sum(N),
          ) %>% 
  plot_ly (x=~alcohol_use_cat, y= ~ Proportion * 100, type = "bar", color = ~total_cholesterol) %>% 
  layout(barmode = "stack",
         title = "Distribution of High Total Cholersterol by Drinking Habits",
         xaxis = list(title = "Drinking Habits"),
         yaxis = list(title = "Percentage (%)")
         )
```
According to the graph, the percentage of high cholesterol increase as people drink more. 30% percent of the light drinkers have high cholesterol while 40 % of heavy drinker have high cholesterol level. 

The fourth variabe is serum cotinine , which is a metabolism of nicotine and works as a biomarker for smoker. According to [CDC] (https://www.cdc.gov/biomonitoring/Cotinine_BiomonitoringSummary.html) the  cutoff point of cotinine for smoker and nonsmoker is 10ng/ml. The serum cotinie level in smoker distribute like this :


```{r message = FALSE, warning = FALSE}

combine_tc_binary =
  combine_tc_binary %>% 
  mutate(smoking_status_bi = ifelse(cotinine > 10, "Smoker", "Nonsmoker"),
         smoking_status_bi = factor(smoking_status_bi, levels = c("Nonsmoker","Smoker")))
  
```



```{r message = FALSE, warning = FALSE}
a= 
    combine_tc_binary %>% 
    filter (smoking_status_bi == "Smoker") %>% 
    ggplot (aes(x= cotinine)) +
    geom_density() +
    labs (title = "Serum Cotinine Value in Smoker" , x = "Cotinine")

b= 
    combine_tc_binary %>% 
    filter (smoking_status_bi == "Nonsmoker") %>% 
    ggplot (aes(x= cotinine)) +
    geom_density() +
    labs (title = "Serum Cotinine Value in Nonsmoker", x ="Cotinine" )


grid.arrange(a, b, ncol=2 ) 

```

The cotinine level is a left-skew line in smokers, and it is  centered around 0.00 ng/ml in non-smokers. 


The relationship between cotinine and total cholesterol is shown as below: 

```{r message = FALSE, warning = FALSE }
combine_tc_binary  %>% 
  group_by(smoking_status_bi,total_cholesterol) %>% 
  summarise(N = n()) %>% 
  mutate (Proportion = N/sum(N),
          ) %>% 
  plot_ly (x=~smoking_status_bi, y= ~ Proportion * 100, type = "bar", color = ~total_cholesterol) %>% 
  layout(barmode = "stack",
         title = "Distribution of High Total Cholersterol by Smoker and Nonsmoker",
         xaxis = list(title = "Smoking status"),
         yaxis = list(title = "Percentage (%)")
         )
```

According to the graph, the proportions of total cholesterol level  in smoker and non-smoker are almost the same. 

To test the strength of the association, we would like to use regression model to do further analysis. 

# R Shiny App for Risk Prediction

We built a Shiny app to let use input their information including age, gender, race, education level, average annual family income, and use them into the selected fitted model as predictors' values. Then the app outputs a predicted result of total cholesterol level and then based on this value to output if it's above the normal level or at the normal level by comparing the total cholesterol value with 200 mg/dL.
