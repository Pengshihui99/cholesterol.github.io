---
title: "Model"
author: "Shihui Peng"
date: "2023-12-04"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r, message=FALSE}
# load packages and basic settings
library(tidyverse)
library(modelr)
library(purrr)
library(corrplot)

set.seed(1)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

# import data (currently: using direct path)

# total cholesterol < 200 -> 0, >= 200 -> 1
model_df = read_csv("~/desktop/combine.csv") |> 
  mutate(
    chol_cat = ifelse(total_cholesterol < 200, 0, 1),
    alcohol_use_order = as.factor(alcohol_use_order),
    physical_activity = relevel(as.factor(physical_activity), ref = "Light/Unknown activity")
  )

# create subset for cholestorl level of desirable level and of above desirable level 
desire_df = 
  model_df |> 
  filter(chol_cat == 0)

ab_desire_df = 
  model_df |> 
  filter(chol_cat == 1)
```


# Description of variables features

## Continuous variables

### Methods

For continuous variables, we use **mean** and **standard deviation** (std) to describe the distribution in overall samples, samples of desirable cholesterol level (defined as "control"), and samples of above-desirable cholesterol level (defined as "case"). Then, we use **t-test** to examine whether the means of these variables are significantly different between case group and control group (significance level = 0.05).
```{r, message=FALSE}
# mean and std for continuous variables, overall
list_conti_all = list(
  age = model_df$age, 
  bmi = model_df$bmi, 
  sleep_hour = model_df$sleep_hour, 
  cotinine = model_df$cotinine,
  chol_cat = model_df$chol_cat
) |> 
  as.data.frame()

list_conti_all_clean = 
  list_conti_all[-5] |> 
  lapply(na.omit)

mean_all = sapply(list_conti_all_clean, mean) |> 
  as.data.frame() |> 
  rename(overall_mean = "sapply(list_conti_all_clean, mean)")

std_all = sapply(list_conti_all_clean, sd) |> 
  as.data.frame() |> 
  rename(overall_std = "sapply(list_conti_all_clean, sd)")

# p-value of t test for continuous variables
t_test = function(variable) {
  t_test_result = t.test(list_conti_all[[variable]] ~ list_conti_all$chol_cat)
  return(data.frame(
    variable = variable,
    p_value = t_test_result$p.value
  ))
}

p_value = 
  lapply(c("age", "bmi", "sleep_hour", "cotinine"), t_test) |>
  bind_rows()

# mean and std for all continuous variables, among samples of desirable cholesteral level (named them as "control")
list_conti_desire = list(
  age = desire_df$age, 
  bmi = desire_df$bmi, 
  sleep_hour = desire_df$sleep_hour, 
  cotinine = desire_df$cotinine
) |> 
  as.data.frame() |> 
  lapply(na.omit)

mean_desire = sapply(list_conti_desire, mean) |> 
  as.data.frame() |> 
  rename(control_mean = "sapply(list_conti_desire, mean)")

std_desire = sapply(list_conti_desire, sd) |> 
  as.data.frame() |> 
  rename(control_std = "sapply(list_conti_desire, sd)")

# mean and std for all continuous variables, among samples of above-desirable cholesterol level (named them as "case")
list_conti_ab_desire = list(
  age = ab_desire_df$age, 
  bmi = ab_desire_df$bmi, 
  sleep_hour = ab_desire_df$sleep_hour, 
  cotinine = ab_desire_df$cotinine
) |> 
  as.data.frame() |> 
  lapply(na.omit)

mean_ab_desire = sapply(list_conti_ab_desire, mean) |> 
  as.data.frame() |> 
  rename(case_mean = "sapply(list_conti_ab_desire, mean)")

std_ab_desire = sapply(list_conti_ab_desire, sd) |> 
  as.data.frame() |> 
  rename(case_std = "sapply(list_conti_ab_desire, sd)")
```

### description table

```{r}
# combind - continuous
conti_des_df =
  cbind(mean_all, std_all, mean_desire, std_desire, mean_ab_desire, std_ab_desire, p_value) |> 
  select(overall_mean, overall_std, p_value, control_mean, control_std, case_mean, case_std) |> 
  knitr::kable(digits = 3)

conti_des_df
```

## Binary and categorical variables

### Methods

For binary and categorical variables, we use **count** (n) and **percentage** (pct) to describe the distribution in overall samples, samples of desirable cholesterol level (defined as "control"), and samples of above-desirable cholesterol level (defined as "case"). Then, we use **chi-sq test** to examine whether the distribution of these variables are significantly different between case group and control group (significance level = 0.05).
```{r}
# n and pct for categorical variables, chi-sq test, overall
list_cat_all = list (
  gender = model_df$gender,
  race = model_df$race,
  marital = model_df$marital_status,
  edu = model_df$education_level_20,
  poverty = model_df$poverty_level,
  phy = model_df$physical_activity,
  alcohol = model_df$alcohol_use_cat,
  chol_cat = model_df$chol_cat
) |> 
  as.data.frame()

list_cat_all_clean = 
  list_cat_all[-8] |> 
  lapply(na.omit)

cat_vars = names(list_cat_all_clean)

count_all_function = function(variable) {
  table_value = table(list_cat_all[[variable]], list_cat_all$chol_cat)
  chi_sq_test = chisq.test(table_value)
  
  count = sapply(unique(list_cat_all_clean[[variable]], na.rm = TRUE), function(cat) sum(list_cat_all_clean[[variable]] == cat, na.rm = TRUE))
   
  total = sum(count)
  pct = count / total
  
  result_df = tibble(
    variable = names(count),
    n = count,
    pct = pct,
    p_value = chi_sq_test$p.value
    )
  
  return(result_df)
  }

cat_count_chisq = lapply(cat_vars, count_all_function) |> 
  bind_rows()

# n and pct for categorical variables, among samples of desirable cholesteral level (named them as "control")
list_cat_ctrl = list (
  gender = desire_df$gender,
  race = desire_df$race,
  marital = desire_df$marital_status,
  edu = desire_df$education_level_20,
  poverty = desire_df$poverty_level,
  phy = desire_df$physical_activity,
  alcohol = desire_df$alcohol_use_cat
) |> 
  as.data.frame() |> 
  lapply(na.omit)

cat_vars_ctrl = names(list_cat_ctrl)

count_ctrl_function = function(variable) {
  count = sapply(unique(list_cat_ctrl[[variable]], na.rm = TRUE), function(cat) sum(list_cat_ctrl[[variable]] == cat, na.rm = TRUE))
   
  total = sum(count)
  pct = count / total
  
  result_df = tibble(
    variable = names(count),
    control_n = count,
    control_pct = pct
    )
  
  return(result_df)
}

cat_count_ctrl = lapply(cat_vars_ctrl, count_ctrl_function) |> 
  bind_rows()

# n and pct for categorical variables, among samples of above-desirable cholesterol level (named them as "case")
list_cat_case = list (
  gender = ab_desire_df$gender,
  race = ab_desire_df$race,
  marital = ab_desire_df$marital_status,
  edu = ab_desire_df$education_level_20,
  poverty = ab_desire_df$poverty_level,
  phy = ab_desire_df$physical_activity,
  alcohol = ab_desire_df$alcohol_use_cat
) |> 
  as.data.frame() |> 
  lapply(na.omit)

cat_vars_case = names(list_cat_case)

count_case_function = function(variable) {
  count = sapply(unique(list_cat_case[[variable]], na.rm = TRUE), function(cat) sum(list_cat_case[[variable]] == cat, na.rm = TRUE))
   
  total = sum(count)
  pct = count / total
  
  result_df = tibble(
    variable = names(count),
    case_n = count,
    case_pct = pct
    )
  
  return(result_df)
}

cat_count_case = lapply(cat_vars_case, count_case_function) |> 
  bind_rows()
```

### description table

```{r, message=FALSE}
cat_des_df =
  bind_cols(cat_count_chisq, cat_count_ctrl, cat_count_case) |> 
  select(-variable...5, -variable...8) |> 
  rename(variable = variable...1) |> 
  knitr::kable(digits = 3)

cat_des_df
```

# Building model

In this study, out response variable is total cholesterol level (`total_cholesterol`), and our explanatory variables are (1)cotinine (`cotinine`), (2) physical activity (`physical_activity`), and (3) alcohol use (`alcohol_use_cat`).  We decide to analyze the association step by step. (significance level = 0.05)

## Check the dataset

```{r, message=FALSE}
model_df |> 
  ggplot(aes(x = cotinine, y = total_cholesterol)) + geom_point()

model_df |> 
  ggplot(aes(x = alcohol_use_cat, y = total_cholesterol)) + geom_point()

model_df |> 
  ggplot(aes(x = physical_activity, y = total_cholesterol)) + geom_point()
```

Based on the scatterplot, we can find slightly negative linear trends. Therefore, we decide to use linear regression model.

## Model selection


### 1. main explanatory variable: cotinine


#### Univariate linear regression: total_cholesterol = cotinine

```{r, message=FALSE}
fit_1 = lm(total_cholesterol ~ cotinine, data = model_df)

fit_1 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)

model_df |> 
  modelr::add_residuals(fit_1) |> 
  ggplot(aes(sample = resid)) +
  stat_qq() +
  stat_qq_line()
```

We can see that cotinine is significantly associated with total cholesterol level. We also check the qq-plot and find that the residuals among followed a normal distribution, which indicates a suitability of using linear regression.


#### Test between cotinine and other potential covariables

```{r}
lm(cotinine ~ age, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

lm(cotinine ~ gender, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

lm(cotinine ~ race, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

lm(cotinine ~ marital_status, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

lm(cotinine ~ education_level_20, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

lm(cotinine ~ poverty_level, data = model_df) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)
```

We can find that all the potential covariables are significantly associated with continine, indicating that they eligible for being considered as confounders. Therefore, covariables age, gender, martial_status, education_level_20, and poverty_level will be added into our multivariable linear regression.


#### Multivariable linear regression

fit_cot: total_cholesterol = cotinine + age + gender + race + marital_status + education_level_20 + poverty_level

```{r}
fit_cot = lm(total_cholesterol ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_df)

fit_cot |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```


### 2. main explanatory variable: physical_activity


#### Univariate linear regression: total_cholesterol = physical_activity

```{r, message=FALSE}
fit_2 = lm(total_cholesterol ~ physical_activity, data = model_df)

fit_2 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)

model_df |> 
  modelr::add_residuals(fit_2) |> 
  ggplot(aes(sample = resid)) +
  stat_qq() +
  stat_qq_line()
```

We can see that physical_activity is not significantly associated with total cholesterol level. We also check the qq-plot and find that the residuals among followed a normal distribution, which indicates a suitability of using linear regression.


#### Test between physical_activity and other potential covariables

```{r}
model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ age, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ gender, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ race, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ marital_status, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ education_level_20, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2))
  ) |> 
  lm(physical_activity ~ poverty_level, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)
```

We can find that all the potential covariables are significantly associated with physical_activity, indicating that they eligible for being considered as confounders. Therefore, covariables age, gender, martial_status, education_level_20, and poverty_level will be added into our multivariable linear regression.


#### Multivariable linear regression

fit_phy: total_cholesterol = physical_activity + age + gender + race + marital_status + education_level_20 + poverty_level

```{r}
fit_phy = lm(total_cholesterol ~ physical_activity + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_df)

fit_phy |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```


### 3. main explanatory variable: alcohol_use_cat


#### Univariate linear regression: total_cholesterol = alcohol_use_cat

```{r, message=FALSE}
fit_3 = lm(total_cholesterol ~ alcohol_use_cat, data = model_df)

fit_3 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)

model_df |> 
  modelr::add_residuals(fit_3) |> 
  ggplot(aes(sample = resid)) +
  stat_qq() +
  stat_qq_line()
```

We can see that alcohol_use_cat is significantly associated with total cholesterol level. We also check the qq-plot and find that the residuals among followed a normal distribution, which indicates a suitability of using linear regression.


#### Test between alcohol_use_cat and other potential covariables

```{r}
model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ age, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ gender, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ race, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ marital_status, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ education_level_20, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)

model_df |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
  ) |> 
  lm(alcohol_use_cat ~ poverty_level, data = _) |> 
  broom::tidy() |> 
  select(term, estimate, p.value) |> 
  knitr::kable(digits = 3)
```

We can find that all the potential covariables are significantly associated with alcohol_use_cat, indicating that they eligible for being considered as confounders. Therefore, covariables age, gender, martial_status, education_level_20, and poverty_level will be added into our multivariable linear regression.


#### Multivariable linear regression

fit_alc: total_cholesterol = alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level

```{r}
fit_alc = lm(total_cholesterol ~ alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_df)

fit_alc |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```


### 4. explanatory variables: cotinine, physical_activity, and alcohol_use_cat

fit_full: total_cholesterol = cotinine + physical_activity + alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level

```{r}
fit_full = lm(total_cholesterol ~ cotinine + physical_activity + alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_df)

fit_full |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```


### 5. Comparison among models: cross validation


```{r, message = FALSE}
model_cv_df = 
  model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2)),
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2))
    )

# create training and testing sets
cv_df =
  model_cv_df |> 
  crossv_mc(n = 1000) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_results =
  cv_df |> 
  mutate(
    fit_cot = map(train, \(df) lm(total_cholesterol ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level, data = df)),
    fit_phy = map(train, \(df) lm(total_cholesterol ~ physical_activity + age + gender + race + marital_status + education_level_20 + poverty_level, data = df)),
    fit_alc = map(train, \(df) lm(total_cholesterol ~ alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = df)),
    fit_full = map(train, \(df) lm(total_cholesterol ~ cotinine + physical_activity + alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = df))
  ) |> 
  mutate(
    rmse_fit_cot = map2_dbl(fit_cot, test, \(model, df) rmse(model, df)),
    rmse_fit_phy = map2_dbl(fit_phy, test, \(model, df) rmse(model, df)),
    rmse_fit_alc = map2_dbl(fit_alc, test, \(model, df) rmse(model, df)),
    rmse_fit_full = map2_dbl(fit_full, test, \(model, df) rmse(model, df))
  )

cv_results |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model_type",
    values_to = "rmse",
    names_prefix = "rmse_"
  ) |> 
  ggplot(aes(x = model_type, y = rmse)) + geom_violin()
```


### 6. Comparison among models: r square

```{r}
rsquare(fit_cot, data = model_df)
rsquare(fit_phy, data = model_df)
rsquare(fit_alc, data = model_df)
rsquare(fit_full, data = model_df)
```










# drafts


### test for logistic model

```{r}
model_cv_log_df = 
  model_df |> 
  mutate(
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2)),
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2)),
    physical_activity = as.numeric(physical_activity),
    alcohol_use_cat = as.numeric(alcohol_use_cat)
    )

log_fit_cot = glm(chol_cat ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())

log_fit_phy = glm(chol_cat ~ physical_activity + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())

log_fit_alc = glm(chol_cat ~ alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())

log_fit_full = glm(chol_cat ~ cotinine + physical_activity + alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())

# r^2
rsquare(log_fit_cot, data = model_cv_log_df)
rsquare(log_fit_phy, data = model_cv_log_df)
rsquare(log_fit_alc, data = model_cv_log_df)
rsquare(log_fit_full, data = model_cv_log_df)

# rmse

# create training and testing sets
cv_log_df =
  model_cv_log_df |> 
  crossv_mc(n = 100) |> 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)
  )

cv_log_results =
  cv_log_df |> 
  mutate(
    log_fit_cot = map(train, \(df) glm(chol_cat ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())),
    log_fit_phy = map(train, \(df) glm(chol_cat ~ physical_activity + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())),
    log_fit_alc = map(train, \(df) glm(chol_cat ~ alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial())),
    log_fit_full = map(train, \(df) glm(chol_cat ~ cotinine + physical_activity + alcohol_use_cat + age + gender + race + marital_status + education_level_20 + poverty_level, data = model_cv_log_df, family = binomial()))
  ) |> 
  mutate(
    rmse_log_fit_cot = map2_dbl(log_fit_cot, test, \(model, df) rmse(model, df)),
    rmse_log_fit_phy = map2_dbl(log_fit_phy, test, \(model, df) rmse(model, df)),
    rmse_log_fit_alc = map2_dbl(log_fit_alc, test, \(model, df) rmse(model, df)),
    rmse_log_fit_full = map2_dbl(log_fit_full, test, \(model, df) rmse(model, df))
  )

cv_log_results |> 
  select(starts_with("rmse")) |> 
  pivot_longer(
    everything(),
    names_to = "model_type",
    values_to = "rmse",
    names_prefix = "rmse_log_"
  ) |> 
  ggplot(aes(x = model_type, y = rmse)) + geom_violin()
```


##### logistic

x = cotinine
```{r}
fit1 = glm(chol_cat ~ cotinine, data = model_df, family = binomial())

fit1 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)

fit2 = glm(chol_cat ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level, family = binomial(), data = model_df)

fit3 = glm(chol_cat ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level + physical_activity + alcohol_use_cat, data = model_df, family = binomial())

fit3 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```

##### test for stratified linear regression

```{r}
test_df =
  model_df |> 
  filter(gender == "Male")

fit_2 = lm(total_cholesterol ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level + physical_activity + alcohol_use_cat, data = model_df)

fit_2 |> 
  broom::tidy() |> 
  knitr::kable(digits = 3)
```


##### test for bin / cat cotinine level

```{r}
test_df = 
  model_df |> 
  mutate(
    coti_cat = ifelse(cotinine <= 10, 0, ifelse(cotinine > 10 & cotinine < 500, 1, 2))
  )

fit_2 = lm(total_cholesterol ~ coti_cat + age + gender + race + marital_status + education_level_20 + poverty_level + physical_activity + alcohol_use_cat, data = test_df) |> 
  broom::tidy() |> 
  knitr::kable()
```
binary & categorial: neither sig

##### test for x and covariables

```{r}
model_df |> 
  filter(!is.na(alcohol_use_cat)) |> 
  mutate(
    alcohol_use_cat = ifelse(alcohol_use_cat == "Light Drinker", 0, ifelse(alcohol_use_cat == "Moderate Drinker", 1, 2)),
    physical_activity = ifelse(physical_activity == "Light/Unknown activity", 0, ifelse(physical_activity == "Moderate activity", 1, 2)),
    alcohol_use_cat = as.numeric(alcohol_use_cat)
  ) |> 
  select(cotinine, alcohol_use_cat, physical_activity) |> 
  cor() |> 
  corrplot()
```


##### test for multicolinearity (linear model)

```{r}
test_vif = 
  model_df |> 
  select(total_cholesterol, age, cotinine, gender, race, marital_status, education_level_20, poverty_level, physical_activity, alcohol_use_cat)

fit_vif = lm(total_cholesterol ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level + physical_activity + alcohol_use_cat, data = test_vif)

car::vif(fit_vif)
```
VIF = 1: There is no correlation between a given predictor variable and any other predictor variables in the model.
VIF between 1 and 5: There is moderate correlation between a given predictor variable and other predictor variables in the model.
VIF > 5: There is severe correlation between a given predictor variable and other predictor variables in the model.

##### test for heteroscedasticity (linearmodel)
```{r}
fit_vif = lm(total_cholesterol ~ cotinine + age + gender + race + marital_status + education_level_20 + poverty_level + physical_activity + alcohol_use_cat, data = test_vif)

test_vif |> 
  add_residuals(fit_vif) |> 
  ggplot(aes(y = resid, x = cotinine)) + geom_point(col = 'blue') + geom_abline(slope = 0)
```
there is a trend --> when x=cotinine, there is a prob of heteroscedasticity.
